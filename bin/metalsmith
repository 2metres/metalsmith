#!/usr/bin/env node

var exists = require('fs').existsSync;
var Metalsmith = require('..');
var program = require('commander');
var resolve = require('path').resolve;

/**
 * Program.
 */

program
  .option('-c, --config <file>', 'set an alternate config file')
  .parse(process.argv);

/**
 * Settings.
 */

var config = resolve(process.cwd(), program.config || 'metalsmith.json');
var json = exists(config) ? require(config) : {};

/**
 * Metalsmith.
 */

var metalsmith = new Metalsmith(process.cwd());
if (json.source) metalsmith.source(json.source);
if (json.destination) metalsmith.destination(json.destination);
if (json.metadata) metalsmith.metadata(json.metadata);

/**
 * Plugins.
 */

for (var key in json.plugins) {
  var plugin;
  var opts = json.plugins[key];

  try {
    plugin = require(key);
  } catch (e) {
    console.error('failed to require plugin "' + key + '"');
    process.exit(1);
  }

  metalsmith.use(plugin(opts));
}

/**
 * Build.
 */

metalsmith.build(function(err){
  if (err) return console.error(err);
  console.log('built');
});